{% extends "base.html" %}

{% block head %}

    <script src="/static/js/history.js"></script>

{% endblock %}


{% block content %}
<div class="container">
    <div class="row">
		<div class="col-sm-4" id="feedlist">
		    <h2 class="ftheader">Feeds</h2>
			<div id="feeds">
			
			    {% if all %}
					<div class="feedbutton">
						<a href="/feeds/" class="feedbutton">Unread Feeds</a> 
					</div>
				{% else %}
					<div class="feedbutton">
						<a href="/allfeeds/" class="feedbutton">All Feeds</a> 
					</div>
                {% endif %}

				{% for s in sources %}
					<div id="s{{s.id}}" class="feedbutton{% if not s.source %} group{% endif %}"> 
						<a id="sa{{s.id}}" onclick="read({{s.id}})" href="#" class="feedbutton">{{s.name}}<span id="uc{{s.id}}" class="unreadcount">{% if s.isRiver %}R{% else %}({{s.unreadCount}}){% endif %}</span></a> 
					</div>
				{% endfor %}
			</div>
		</div>
            		
        <div class="col-sm-8" id="feedpane">
            <img src="/static/images/FeedThing.png" class="paneplant">
        </div>
    </div>
</div>	
        {% csrf_token %}

<script>

//console.log('yo!');

var lastRead = null;

function read(fid){


    if (lastRead == fid) {
        return;
    }

    {% if all %}
        $("#uc" + fid).html("(0)");
        if (lastRead != null) {
            $("#s" + lastRead).removeClass("read");    
        }
    {% else %}
        if (lastRead != null) {
            $("#s" + lastRead).fadeOut("fast");    
        }
    {% endif %}

    lastRead = fid;
    
    $("#s" + lastRead).addClass("read");  
    
    $("#feedpane").html('<div id="feedcontent"> <img src="/static/images/FeedThing.png" class="paneplant"></div>');

    var qty = "/all/";
    if (fid == "river") {
        qty = "/25/";
    }

	$.get("/read/" + fid + qty,function(data){
	   $("#feedpane").html(data);
	   History.pushState({feed:fid}, "FeedThing", "?feed=" + fid);
	   
	});


    
    return false;
}


$(document).ready(function(){


	// Bind to StateChange Event
	History.Adapter.bind(window,'statechange',function(){ // Note: We are using statechange instead of popstate
		//console.log("statechange");


		var State = History.getState(); // Note: We are using History.getState() instead of event.state
		
		
		if (!State.data.hasOwnProperty("feed")) {
		    //console.log("unreading");
		    // this is a reset
		    unRead();
		} else {
		    read(State.data.feed,"all");
		}	
		//debugger;
		
	});
	
	History.pushState(null,null,"#");

    {% if preload != "0" %}
        read({{preload}}, "all");
    {% endif %}

});



function unRead() {
    //window.history.back();
    //if(event.state) {

        {% if not all %}
            $("#s" + lastRead).fadeOut("fast");
        {% endif %}

        $("#feedcontent").fadeOut("fast",function(){
            $("#feedpane").html('<img src="/static/images/FeedThing.png" class="paneplant">');            
        });    
    
    //}

}


function unsub(sid)
{
	if (confirm("Sure?"))
	{
		$("#unsub").html('<div id="loader"><img src="/static/images/loader.gif" alt="Working" width="32" height="32"></div>');
		$.post("/subscription/" + sid +"/unsubscribe/",function(data){
		
			$("#loader").fadeOut(function(){
				$("#loader").html(data);
				$("#loader").fadeIn();
			});
		
		},'html');
	}
	
}






</script>



{% endblock %}


